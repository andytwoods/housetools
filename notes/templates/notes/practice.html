{% extends 'base.html' %}
{% load static %}

{% block css %}
  {{ block.super }}

  <style>

    .draggable {
      touch-action: none;
      user-select: none;
    }

    #sheet {
      width: 100%; /* Container takes full width */
      height: 250px; /* Define the height for the stave */
      border: 1px solid #ccc; /* Optional: Add a border */
      display: flex;
      justify-content: center; /* Horizontally center the stave */
      align-items: center; /* Vertically center the stave */
    }

    /* Ensure the SVG dynamically adjusts */
    svg {
      display: block; /* Ensure no extra spaces due to inline SVG behavior */
    }

    .draggable-box {
      display: flex;
      flex-direction: column; /* Stack buttons vertically */
      justify-content: space-around; /* Space evenly between buttons */
      align-items: center; /* Center-align buttons horizontally in the container */
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 150px; /* Adjust width for vertical layout */
      height: 300px; /* Make the box taller to fit vertical buttons */
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: grab;
    }

    .drag-handle {
      width: 100%;
      top: -30px;
      left: -30px;
      cursor: grab; /* Show a grab cursor */
      text-align: left;
      border-radius: 6px 6px 0 0; /* Rounded corners only at the top */
    }

    .trumpet {
      width: 90%;
      height: 30%;
      margin:10px;
      border-radius: 50%;
    }

    /* Buttons inside the box */
    .draggable-box button {
      padding: 10px 20px;
      border: none;
      background-color: #3478f6;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }

    .draggable-box button:hover {
      top: -30px;
      left: -30px;
    }

    /* Resize/rotate handles (for resizing and rotating the box) */
    .resize-handle {
      width: 10px;
      height: 10px;
      position: absolute;
    }

    .resize-handle.br { /* Bottom-Right handle */
      bottom: -5px;
      right: -5px;
      cursor: se-resize;
    }

    .resize-handle.rotate { /* Rotate handle */
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      width: 15px;
      height: 15px;
      border-radius: 50%;
      cursor: grab;
    }
  </style>
{% endblock css %}

{% block javascript %}

  <script src="{% static 'js/vexflow.js' %}"></script>


{% endblock javascript %}

{% block title %}
  Child Page Title
{% endblock %}

{% block content %}
  <h2>Practice</h2>

  <div class="row">
    <div class="col-12">
      <h5>Trumpet note/fingering learning tool</h5>
    </div>
    <div class="col-12 align-self-center text-center">

      <div id="sheet"></div>
    </div>

  </div>

  <div class="draggable-box" id="draggable-container">
    <div class="drag-handle">
      <i class="fa-solid fa-arrows-up-down-left-right"></i>
    </div> <!-- Dragging handle -->
    <div class="resize-handle rotate">
      <i class="fa-solid fa-rotate"></i>
    </div>
    <button class="btn btn-secondary trumpet">3</button>
    <button class="btn btn-secondary trumpet">2</button>
    <button class="btn btn-secondary trumpet">1</button>
    <div class="resize-handle br">
      <i class="fa-solid fa-up-right-and-down-left-from-center"></i>
    </div>
  </div>

  <script type="module">
    import 'https://cdn.interactjs.io/v1.9.20/auto-start/index.js'
    import 'https://cdn.interactjs.io/v1.9.20/actions/drag/index.js'
    import 'https://cdn.interactjs.io/v1.9.20/actions/resize/index.js'
    import interact from 'https://cdn.interactjs.io/v1.9.20/interactjs/index.js'


    const container = document.getElementById("draggable-container");

    let rotationAngle = 0;

    // Make the box draggable using the handle
    interact(container).draggable({
      allowFrom: '.drag-handle', // Enable dragging only from the handle
      listeners: {
        move(event) {
          const {dx, dy} = event;
          const style = window.getComputedStyle(container);
          const matrix = new DOMMatrix(style.transform);

          const x = (matrix.m41 || 0) + dx;
          const y = (matrix.m42 || 0) + dy;

          container.style.transform = `translate(${x}px, ${y}px) rotate(${rotationAngle}deg)`;
        },
      },
    });

    // Make the box resizable
    interact(container).resizable({
      edges: {bottom: true, right: true},
      modifiers: [
        interact.modifiers.restrictSize({
          min: {width: window.innerWidth * 0.05, height: window.innerHeight * 0.10}, // Minimum dimensions
        }),
      ],
      listeners: {
        move(event) {
          const {width, height} = event.rect;

          container.style.width = `${width}px`;
          container.style.height = `${height}px`;

          container.style.transform = event.target.style.transform;
        },
      },
    });

    // Add smoother rotation
    interact(".resize-handle.rotate").draggable({
      listeners: {
        move(event) {
          const rect = container.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          const deltaX = event.clientX - centerX;
          const deltaY = event.clientY - centerY;

          const rawAngle = Math.atan2(deltaY, deltaX) * (180 / Math.PI) + 90;

          const sensitivityFactor = 0.1;
          rotationAngle += sensitivityFactor * (rawAngle - rotationAngle);

          container.style.transform = `translate(-50%, -50%) rotate(${rotationAngle}deg)`;
        },
      },
    });
  </script>

  <script>


    function sendListToBackend(list) {

      // Sending the POST request to the backend
      const response = fetch("{% url 'practice-data' learningscenario_id=learningscenario_id %}", {
        method: 'POST', // HTTP method
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token }}"
        },
        body: JSON.stringify({data: list}) // Convert the list to JSON format
      });

    }
  </script>
  <script>

    const VF = Vex.Flow;  // Reference VexFlow library
    const div = document.getElementById("sheet");
    const containerWidth = div.clientWidth;
    const staveWidth = 200; //

    // Initialize VexFlow renderer
    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(containerWidth, 200);  // Resize the SVG

    const context = renderer.getContext();  // Get the rendering context

    const startX = (containerWidth - staveWidth) / 2; // Calculate the starting point for centering
    const stave = new VF.Stave(startX, 40, staveWidth);
    stave.addClef("treble");  // Add a Treble Clef
    stave.setContext(context); // Attach the context to the stave
    stave.draw(context);       // Draw the stave

    // Function to dynamically show a single note
    function displayNote() {
      // Clear previous rendering
      renderer.getContext().svg.innerHTML = ""; // Clear the SVG context

      // Redraw the stave and attach the context
      stave.setContext(context);
      stave.draw();

      // Create a single music note (e.g., "C4")
      const notes = [
        new VF.StaveNote({keys: ["C/4"], duration: "q"})
      ];

      // Format and draw the note
      const voice = new VF.Voice({num_beats: 1, beat_value: 4});
      voice.addTickables(notes);

      new VF.Formatter().joinVoices([voice]).format([voice], 350);
      voice.draw(context, stave);
    }

    // Optional: Programmatically load the first note on startup
    displayNote();  // Show a default note when the page loads

    let notesGroup = null;

    function updateNote(newNote) {
      // Clear the SVG context to remove previous notes
      renderer.getContext().svg.innerHTML = "";

      // Redraw the stave
      stave.setContext(context);
      stave.draw();

      const noteX = staveWidth / 2; // Calculate the horizontal center of the stave

      // Create a single note using the passed `newNote`
      const note = new VF.StaveNote({keys: [newNote], duration: "q", align_center: true})

      // Add notes to a voice and render
      const voice = new VF.Voice({num_beats: 1, beat_value: 4});
      voice.addTickables([note]);

      new VF.Formatter().joinVoices([voice]).format([voice], noteX);
      voice.draw(context, stave);
    }

    // Optional: Display a default note on load
    updateNote('C/4'); // Show "C4" by default when the page loads

  </script>
{% endblock content %}
